name: CI - Pull Request para Develop

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: "3.10"

jobs:
  lint:
    name: ğŸ” Lint e ValidaÃ§Ã£o de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
          pip install -r requirements.txt
      
      - name: ğŸ¨ Verificar formataÃ§Ã£o com Black
        run: black --check src/ --line-length 100
        continue-on-error: true
      
      - name: ğŸ“ Verificar imports com isort
        run: isort --check-only --profile black src/
        continue-on-error: true
      
      - name: ğŸ” Lint com Flake8
        run: flake8 src/ --max-line-length=100 --extend-ignore=E203,W503
        continue-on-error: true

  test:
    name: ğŸ§ª Testes
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ§ª Executar testes com pytest
        run: |
          pytest tests/ -v --tb=short || echo "âš ï¸ Testes nÃ£o encontrados ou falharam"
        continue-on-error: true

  validate-structure:
    name: ğŸ“ Validar Estrutura do Projeto
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: âœ… Verificar arquivos essenciais
        run: |
          echo "ğŸ” Verificando arquivos essenciais..."
          
          # Arquivos obrigatÃ³rios
          files=(
            "README.md"
            "requirements.txt"
            "src/main.py"
            "src/api/server.py"
            "src/agent/agent_pr_revisor.py"
            "prompts/registry.yaml"
            "prompts/agent-code-reviewer/v1.0.0/prompt.yaml"
          )
          
          missing=0
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file encontrado"
            else
              echo "âŒ $file nÃ£o encontrado"
              missing=$((missing + 1))
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "âŒ $missing arquivo(s) essencial(is) nÃ£o encontrado(s)"
            exit 1
          else
            echo "âœ… Todos os arquivos essenciais estÃ£o presentes"
          fi
      
      - name: ğŸ“‹ Verificar estrutura de diretÃ³rios
        run: |
          echo "ğŸ” Verificando estrutura de diretÃ³rios..."
          
          dirs=(
            "src"
            "src/api"
            "src/agent"
            "prompts"
            "prompts/agent-code-reviewer"
            "prompts/agent-code-reviewer/v1.0.0"
          )
          
          for dir in "${dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… DiretÃ³rio $dir existe"
            else
              echo "âŒ DiretÃ³rio $dir nÃ£o encontrado"
              exit 1
            fi
          done
          
          echo "âœ… Estrutura de diretÃ³rios vÃ¡lida"

  validate-prompts:
    name: ğŸ“ Validar Prompts
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ Instalar PyYAML
        run: pip install pyyaml
      
      - name: âœ… Validar YAML dos prompts
        run: |
          python -c "
          import yaml
          import sys
          from pathlib import Path
          
          print('ğŸ” Validando arquivos de prompt...')
          
          # Validar registry.yaml
          print('\nğŸ“‹ Validando registry.yaml...')
          try:
              with open('prompts/registry.yaml', 'r') as f:
                  registry = yaml.safe_load(f)
              
              if 'agents' not in registry:
                  print('âŒ registry.yaml: Campo \"agents\" nÃ£o encontrado')
                  sys.exit(1)
              
              print(f'âœ… registry.yaml: VÃ¡lido ({len(registry[\"agents\"])} agente(s) registrado(s))')
              
              # Validar se os caminhos no registry existem
              for agent_name, agent_info in registry['agents'].items():
                  agent_path = Path('prompts') / agent_info.get('path', '')
                  if not agent_path.exists():
                      print(f'âŒ registry.yaml: Caminho do agente \"{agent_name}\" nÃ£o existe: {agent_path}')
                      sys.exit(1)
                  print(f'âœ… Agente \"{agent_name}\": caminho vÃ¡lido')
          
          except yaml.YAMLError as e:
              print(f'âŒ registry.yaml: Erro de sintaxe YAML: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'âŒ registry.yaml: Erro: {e}')
              sys.exit(1)
          
          # Validar prompts individuais
          print('\nğŸ“ Validando prompts individuais...')
          prompt_files = list(Path('prompts').rglob('prompt.yaml'))
          
          if not prompt_files:
              print('âŒ Nenhum arquivo prompt.yaml encontrado')
              sys.exit(1)
          
          errors = 0
          for prompt_file in prompt_files:
              try:
                  with open(prompt_file, 'r') as f:
                      data = yaml.safe_load(f)
                  
                  # Validar estrutura
                  required_keys = ['_type', 'id', 'version', 'input_variables', 'template']
                  missing = [key for key in required_keys if key not in data]
                  
                  if missing:
                      print(f'âŒ {prompt_file}: Faltam campos obrigatÃ³rios: {missing}')
                      errors += 1
                  else:
                      print(f'âœ… {prompt_file}: VÃ¡lido (versÃ£o {data.get(\"version\")})')
              
              except yaml.YAMLError as e:
                  print(f'âŒ {prompt_file}: Erro de sintaxe YAML: {e}')
                  errors += 1
              except Exception as e:
                  print(f'âŒ {prompt_file}: Erro: {e}')
                  errors += 1
          
          if errors > 0:
              print(f'\nâŒ {errors} erro(s) encontrado(s) nos prompts')
              sys.exit(1)
          else:
              print('\nâœ… Todos os prompts sÃ£o vÃ¡lidos')
          "

  check-dependencies:
    name: ğŸ“¦ Verificar DependÃªncias
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Tentar instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --dry-run 2>&1 | tee install.log || true
          
          if grep -i "error" install.log; then
            echo "âŒ Erros encontrados nas dependÃªncias"
            exit 1
          else
            echo "âœ… Todas as dependÃªncias sÃ£o vÃ¡lidas"
          fi
      
      - name: ğŸ”’ Verificar vulnerabilidades conhecidas
        run: |
          pip install safety
          safety check --json || echo "âš ï¸ Vulnerabilidades encontradas (nÃ£o bloqueante)"
        continue-on-error: true

  summary:
    name: ğŸ“Š Resumo do CI
    runs-on: ubuntu-latest
    needs: [lint, test, validate-structure, validate-prompts, check-dependencies]
    if: always()
    
    steps:
      - name: ğŸ“Š Status do CI
        run: |
          echo "================================================"
          echo "ğŸ“Š RESUMO DA EXECUÃ‡ÃƒO DO CI"
          echo "================================================"
          echo ""
          echo "âœ… Lint: ${{ needs.lint.result }}"
          echo "âœ… Testes: ${{ needs.test.result }}"
          echo "âœ… Estrutura: ${{ needs.validate-structure.result }}"
          echo "âœ… Prompts: ${{ needs.validate-prompts.result }}"
          echo "âœ… DependÃªncias: ${{ needs.check-dependencies.result }}"
          echo ""
          echo "================================================"
          
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.validate-structure.result }}" != "success" ] || \
             [ "${{ needs.validate-prompts.result }}" != "success" ] || \
             [ "${{ needs.check-dependencies.result }}" != "success" ]; then
            echo "âŒ CI falhou em uma ou mais etapas crÃ­ticas"
            exit 1
          else
            echo "âœ… Todas as verificaÃ§Ãµes crÃ­ticas passaram!"
          fi

